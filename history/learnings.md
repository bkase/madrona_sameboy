# Learnings
- 2026-01-20: sameboy_core_gpu.cpp includes must stay in sync with SAMEBOY_CORE_SRCS in src/CMakeLists.txt for GPU aggregation.
- 2026-01-20: NVRTC compile defs must include sameboy_core_gpu.cpp in madrona_build_compile_defns SRCS so GPU builds see SameBoy C code.
- 2026-01-20: headless_gpu run hits NVRTC errors (time_t/time.h, FILE in apu.h, GB_SECTION zero-length arrays, typeof in gb.h, libcudacxx lacking std::memset/free), so bd-aww now depends on GPU-safe flags/time/audio/file-IO work.
- 2026-01-20: GPU builds now include sameboy_gpu_config.h via GB_GPU_BUILD in NVRTC flags, which defines GB_GPU_MODE and disables timekeeping/debugger/cheats/rewind/audio/file I/O for SameBoy on GPU.
- 2026-01-20: SameBoy build flags are now centralized (GB_DISABLE_TIMEKEEPING/AUDIO/FILE_IO + GB_DMG_ONLY) for CPU/GPU; GB_is_cgb/GB_is_sgb helpers return false when GB_DMG_ONLY is set.
- 2026-01-20: Added GB_init_no_alloc for external RAM/VRAM/MBC/ROM pointers; ownership flags prevent internal free/alloc and MBC RAM realloc.
- 2026-01-20: Guarded SameBoy core allocations with GB_MALLOC/GB_FREE/GB_REALLOC macros so GB_GPU_MODE builds avoid host malloc/free symbols.
- 2026-01-20: RTC/timekeeping now uses GB_HOST_TIME() (0 on GB_GPU_MODE/GB_DISABLE_TIMEKEEPING) so GPU builds avoid time()/time.h while CPU remains unchanged.
- 2026-01-20: File-based ROM/save-state/battery/cheat I/O is stubbed to ENOSYS under GB_DISABLE_FILE_IO; buffer-based save-state APIs still work.
- 2026-01-20: APU/audio is stubbed under GB_DISABLE_AUDIO with no-op helpers and register passthroughs to avoid FILE/std::audio symbols in GPU builds.
- 2026-01-20: GPU misaligned address faults can come from unaligned uint16_t casts in SameBoy memory.c (OAM/MBC7); use unaligned GB_OAM/GB_MBC read/write helpers under GB_GPU_MODE.
- 2026-01-20: headless cpu_instrs.gb did not complete within 600 frames in the current build (reached test 9 by 1000 frames).
- 2026-01-20: Added a fast_ppu flag; GB_advance_cycles now routes to GB_display_run_scanline when enabled.
- 2026-01-20: CPU Sim init now marks WRAM/VRAM/MBC RAM/ROM bindings as external to avoid frees when using SoA buffers.
- 2026-01-20: headless_gpu uses a device-allocated ROM pointer (cudaMalloc/cudaMemcpy) passed via Sim::Config; verified 60-frame run.
- 2026-01-20: compare_cpu_gpu harness hashes WRAM/VRAM/MBC RAM; cpu_instrs.gb 120f currently mismatches across all three buffers.
- 2026-01-20: compare_cpu_gpu now also hashes packed observations; cpu_instrs.gb 120f mismatches ObsPacked too.
- 2026-01-20: compare_cpu_gpu now exports per-frame PC/SP/LY/STAT; cpu_instrs.gb 120f shows register mismatch too.
- 2026-01-20: compare_cpu_gpu now supports --report JSON output and docs/determinism.md defines zero-drift thresholds.
- 2026-01-20: compare_cpu_gpu --report build/diff_report.json writes JSON even on failure; cpu_instrs.gb 120f still diverges across WRAM/VRAM/MBC/obs/regs.
- 2026-01-20: headless cpu_instrs.gb passes at 12000 frames on CPU; headless_gpu 12000f did not complete within 120s/300s/600s timeouts (still running after init).
- 2026-01-20: Enabled warnings-as-errors for project targets; SameBoy headers are treated as system and sameboy_core suppresses multichar/unused-result warnings so Werror builds succeed.
- 2026-01-20: headless_gpu in Debug opt mode runs ~2 FPS for 1 world (120 frames took ~60s), so 12000 frames would take ~100 min; perceived hang is extreme slowness.
- 2026-01-20: compute-sanitizer memcheck on headless_gpu (10 frames) reports invalid global write in StateManager::makeEntityNow (state.cpp:523) during initWorlds, followed by unspecified launch failure.
- 2026-01-20: headless cpu_instrs.gb passes by 6000 frames on CPU (prints "Passed").
- 2026-01-20: madrona Optimize mode NVJitLink failed when -lto was always passed; restricting -lto to LTO mode fixes NVJitLink errors and allows Optimize GPU compiles.
- 2026-01-20: headless_gpu in Optimize mode (with runAsync stream) runs ~17 FPS for 1 world; 12000 frames still ~11–12 minutes, so 2-minute timeout remains out of reach without deeper changes.
- 2026-01-20: Added --benchmark/--bench to headless/headless_gpu to run fixed frames without pass checks; benchmark mode disables rendering in Sim::Config.
- 2026-01-20: Benchmark results (120 frames): CPU ~30–37k total FPS for 64–256 worlds; GPU ~425 total FPS (64 worlds) and ~783 total FPS (256 worlds), so GPU throughput is far below CPU in current madrona setup.
- 2026-01-20: CuLE paper notes: renders frames directly on GPU to avoid CPU↔GPU bandwidth; reports up to ~155M frames/hour per GPU; only 25% of raw frames are rendered for training; CPU per-env FPS can beat GPU for ≤128 envs but GPU scales better with many envs.
- 2026-01-20: CuLE repo examples emphasize large env counts (e.g., 1200 ALEs) and minibatching with --use-cuda-env; design centers on GPU envs + batching (torchcule), suggesting throughput gains rely on many parallel envs.
- 2026-01-20: GPU benchmark sweep up to 1024 worlds still tops out ~1,966 FPS total (1.92 FPS/world), far below CPU ~39–40k FPS total, so scaling alone does not close the gap in current madrona setup.
- 2026-01-20: Nsight Systems at 512 worlds shows madronaMWGPUMegakernel_256_1_48 dominating frame time (~390 ms per frame); CPU time is mostly cudaStreamSynchronize waiting on that kernel, so the slowness is primarily inside the megakernel.
- 2026-01-20: Nsight Compute metrics are blocked on this machine (ERR_NVGPUCTRPERM) without enabling GPU performance counters, so deeper kernel metrics require admin/perf-counter enablement.
- 2026-01-20: Batching multiple frames per step (framesPerStep=4, 512 worlds) did not improve GPU throughput (~1297 fps vs ~1333 fps baseline), so per-launch overhead is not the dominant bottleneck.
- 2026-01-20: Enabling MADRONA_MWGPU_ENABLE_PGO to build multi-block megakernel variants fails NVJitLink (max-regcount mismatch), blocking occupancy/blocks-per-SM tuning without fixing the regcount constraint.
- 2026-01-20: Null-step baseline (skipping GB_run_frame) runs orders of magnitude faster on GPU (~27.7M fps total at 512 worlds), indicating ECS/SoA layout is not the dominant bottleneck; emulator compute/branching likely is.
- 2026-01-20: Enabling fast_ppu on GPU causes CUDA_ERROR_ILLEGAL_ADDRESS during teardown, so the fast_ppu path is not GPU-safe and can't be used yet to assess PPU cost.
- 2026-01-20: compute-sanitizer on fast_ppu (1 world) still reports invalid global write in madrona StateManager::makeEntityNow during initWorlds, suggesting a lingering GPU init bug independent of fast_ppu.
- 2026-01-20: compute-sanitizer on --null-step (1 world) hits the same StateManager::makeEntityNow invalid write, so the initWorlds bug is independent of emulation and likely in Madrona GPU ECS init.
- 2026-01-20: fast_ppu runs succeed at 1 world but crash at 512 worlds, indicating the illegal access scales with world count rather than being immediate for a single world.
- 2026-01-20: Reverting GBMachine max entities per world to default (0) does not remove compute-sanitizer invalid write in StateManager::makeEntityNow (initWorlds), so the error is not caused by the max-entities override; memcheck reports the fault within a 2MB allocation at +0x4.
- 2026-01-20: MADRONA_MWGPU_VERBOSE_HOSTALLOC=1 shows entity/world columns allocate 8 and 4 bytes for 1 world and the run completes, so either compute-sanitizer is flagging Madrona’s virtual-memory allocations or there is a subtle init write issue that does not crash at low world counts.
- 2026-01-20: GPU runtime compilation can break if gb.h is included in helper stubs early; NVRTC reports "extern C" template errors. Forward-declaring GB_gameboy_t and defining GB_ENUM locally avoids pulling gb.h/save_state.h into the stub TU and fixes NVRTC compilation.
- 2026-01-20: GPU build now stubs out camera/printer/rumble/sgb/workboy modules via src/sameboy_gpu_stubs.c and removes their .c includes from sameboy_core_gpu.cpp; headless_gpu --benchmark --null-step cpu_instrs.gb 1 1 runs successfully.
- 2026-01-20: GB_GPU_MODE now bypasses float-heavy color correction paths in display.c (linear RGB scaling only) and skips faux-analog float math in joypad.c; GPU null-step still runs and compiles.
- 2026-01-20: headless_gpu only copies input once at init and observations at the end (unless --benchmark), so per-frame host↔device copies are not a bottleneck in the current benchmark path.
- 2026-01-20: MADRONA_MWGPU_KERNEL_CACHE must point to a file path that doesn't exist yet; pointing it at a directory triggers a strnlen crash while parsing the cache.
- 2026-01-20: Multi-block megakernel configs depend on guaranteed occupancy; removing launch-bounds min-blocks lets PGO compile, but exec-config overrides with blocks>1 hang, so real tuning likely requires lowering register pressure or compiling out high-reg code paths.
- 2026-01-20: A GPU-only --skip-ppu mode that fakes vblank every LCDC_PERIOD yields ~3.1× throughput improvement at 512 worlds, indicating PPU work is a major contributor but not the sole bottleneck. A true CPU/PPU kernel split would require deeper decoupling inside SameBoy’s timing path.
- 2026-01-20: Rendering every Nth frame (via renderEvery/--render-every) yields a ~2.2× GPU throughput gain at N=4, but still leaves a large gap vs CPU; render decimation helps but emulator CPU/PPU cost remains dominant.
- 2026-01-20: SameBoy’s PPU (GB_display_run_scanline / render_line) is stateful and sequential (FIFO, OAM scan, STAT/LY updates per line), so per-world parallelization would require a major PPU rewrite rather than a simple taskgraph change.
